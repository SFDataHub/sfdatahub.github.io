rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----- Public reads -----
    match /metadata/{doc}         { allow read: if true; }
    match /servers/{doc}          { allow read: if true; }
    match /stats_public/{doc=**}  { allow read: if true; }

    // Uebergangs-Gate (bis Auth/AppCheck)
    function isImporter() { return true; }

    function isAdmin() {
      return request.auth != null && request.auth.token.roles != null && request.auth.token.roles.hasAny(['admin', 'owner']);
    }

    // Access control configuration (used by Control Panel / Access & Features)
    match /feature_access/{featureId} {
      // Jeder Client darf die Konfiguration lesen; Mutationen laufen ueber auth-api/Service Account.
      allow read: if true;
      allow write: if false;
    }

    match /access_groups/{groupId} {
      allow read: if true;
      allow write: if false;
    }

    // ---------- Players ----------
    match /players/{pid} {
      allow read: if true;
      allow create, update: if isImporter();
      allow delete: if false;

      match /scans/{ts} {
        allow read: if true;
        allow create: if isImporter();
        allow update, delete: if false;
      }
      match /latest/{docId} {
        allow read: if true;
        allow create, update: if isImporter();
        allow delete: if false;
      }
      match /history_weekly/{wid} {
        allow read: if true;
        allow create, update: if isImporter();
        allow delete: if false;
      }
      match /history_monthly/{ym} {
        allow read: if true;
        allow create, update: if isImporter();
        allow delete: if false;
      }
    }

    // ---------- Guilds ----------
    match /guilds/{gid} {
      allow read: if true;
      allow create, update: if isImporter();
      allow delete: if false;

      match /scans/{ts} {
        allow read: if true;
        allow create: if isImporter();
        allow update, delete: if false;
      }
      match /latest/{docId} {
        allow read: if true;
        allow create, update: if isImporter();
        allow delete: if false;
      }
      match /history_weekly/{wid} {
        allow read: if true;
        allow create, update: if isImporter();
        allow delete: if false;
      }
      match /history_monthly/{ym} {
        allow read: if true;
        allow create, update: if isImporter();
        allow delete: if false;
      }
    }

    // ---------- Links ----------
    match /links_players/{externalKey} {
      allow read: if isImporter();
      allow create, update: if isImporter();
      allow delete: if false;
    }
    match /links_guilds/{externalKey} {
      allow read: if isImporter();
      allow create, update: if isImporter();
      allow delete: if false;
    }

    // ---------- Zusatz nur fuer collectionGroup("latest") ----------
    // Ermoeglicht READ auf *allen* Subcollections namens "latest"
    // (z. B. players/*/latest/*, guilds/*/latest/*) - keine Writes.
    match /{path=**}/latest/{docId} {
      allow read: if true;
    }

    // Rest dicht
    match /{document=**} { allow read, write: if false; }
  }
}
